{% extends 'base.html' %}

{% block title %}Client Details - DebtControl{% endblock %}

{% block content %}
<div class="px-4 py-6 sm:px-0">
    <!-- Back Button -->
    <div class="mb-4">
        <a href="/clients/" class="text-primary hover:text-blue-900">
            <i class="fas fa-arrow-left mr-2"></i> Back to Clients
        </a>
    </div>

    <!-- Client Header -->
    <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
        <div class="flex items-start justify-between">
            <div class="flex items-center">
                <div class="h-20 w-20 rounded-full bg-primary text-white flex items-center justify-center text-3xl font-bold">
                    <span id="clientInitial">?</span>
                </div>
                <div class="ml-6">
                    <h1 class="text-3xl font-bold text-gray-900" id="clientName">Loading...</h1>
                    <p class="text-gray-600 mt-1">
                        <i class="fas fa-envelope mr-2"></i><span id="clientEmail"></span>
                    </p>
                    <p class="text-gray-600 mt-1">
                        <i class="fas fa-phone mr-2"></i><span id="clientPhone"></span>
                    </p>
                    <p class="text-gray-600 mt-1" id="clientAddressContainer" style="display:none;">
                        <i class="fas fa-map-marker-alt mr-2"></i><span id="clientAddress"></span>
                    </p>
                </div>
            </div>
            <div class="flex space-x-3">
                <a href="#" onclick="editClient(); return false;" class="bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-2 rounded-lg">
                    <i class="fas fa-edit mr-2"></i> Edit
                </a>
                <button onclick="deleteClient()" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg">
                    <i class="fas fa-trash mr-2"></i> Delete
                </button>
            </div>
        </div>
    </div>

    <!-- Financial Summary -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
        <div class="bg-white rounded-lg shadow-lg p-6">
            <p class="text-gray-500 text-sm mb-2">Total Debt</p>
            <p class="text-3xl font-bold text-gray-900" id="totalDebt">0 FRw</p>
        </div>
        <div class="bg-white rounded-lg shadow-lg p-6">
            <p class="text-gray-500 text-sm mb-2">Total Paid</p>
            <p class="text-3xl font-bold text-green-600" id="totalPaid">0 FRw</p>
        </div>
        <div class="bg-white rounded-lg shadow-lg p-6">
            <p class="text-gray-500 text-sm mb-2">Balance Due</p>
            <p class="text-3xl font-bold text-red-600" id="balance">0 FRw</p>
        </div>
        <div class="bg-white rounded-lg shadow-lg p-6">
            <p class="text-gray-500 text-sm mb-2">Active Debts</p>
            <p class="text-3xl font-bold text-gray-900" id="activeDebts">0</p>
        </div>
    </div>

    <!-- Tabs -->
    <div class="bg-white rounded-lg shadow-lg overflow-hidden">
        <div class="border-b border-gray-200">
            <nav class="flex -mb-px">
                <button onclick="switchTab('debts')" id="debtsTab" class="px-6 py-4 text-sm font-medium border-b-2 border-primary text-primary">
                    <i class="fas fa-file-invoice-dollar mr-2"></i> Debts
                </button>
                <button onclick="switchTab('payments')" id="paymentsTab" class="px-6 py-4 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700">
                    <i class="fas fa-credit-card mr-2"></i> Payments
                </button>
                <button onclick="switchTab('notifications')" id="notificationsTab" class="px-6 py-4 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700">
                    <i class="fas fa-bell mr-2"></i> Notifications
                </button>
            </nav>
        </div>

        <!-- Debts Tab Content -->
        <div id="debtsContent" class="p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold">Debt History</h3>
                <a href="/debts/" class="bg-primary hover:bg-blue-600 text-white px-4 py-2 rounded-lg text-sm">
                    <i class="fas fa-plus mr-2"></i> Add Debt
                </a>
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Description</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Amount</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Paid</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Balance</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Deadline</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Actions</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200" id="debtsTableBody">
                        <tr><td colspan="7" class="px-6 py-4 text-center text-gray-500">Loading...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Payments Tab Content -->
        <div id="paymentsContent" class="p-6" style="display: none;">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold">Payment History</h3>
                <a href="/payments/" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg text-sm">
                    <i class="fas fa-plus mr-2"></i> Record Payment
                </a>
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Date</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Debt</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Amount</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Reference</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Notes</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200" id="paymentsTableBody">
                        <tr><td colspan="5" class="px-6 py-4 text-center text-gray-500">Loading...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Notifications Tab Content -->
        <div id="notificationsContent" class="p-6" style="display: none;">
            <h3 class="text-lg font-semibold mb-4">Notification History</h3>
            <div class="space-y-4" id="notificationsList">
                <p class="text-center text-gray-500">Loading...</p>
            </div>
        </div>
    </div>
</div>

<!-- Edit Client Modal -->
<div id="editClientModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
    <div class="relative top-20 mx-auto p-5 border w-full max-w-2xl shadow-lg rounded-lg bg-white">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-2xl font-bold text-gray-900">Edit Client</h3>
            <button onclick="closeEditModal()" class="text-gray-400 hover:text-gray-600">
                <i class="fas fa-times text-2xl"></i>
            </button>
        </div>
        
        <form id="editClientForm" onsubmit="saveClientEdit(event)">
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">Full Name *</label>
                <input type="text" id="editName" required
                       class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
            </div>

            <div class="grid grid-cols-2 gap-4 mb-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Email *</label>
                    <input type="email" id="editEmail" required
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Phone</label>
                    <input type="tel" id="editPhone"
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
                </div>
            </div>

            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">Address</label>
                <textarea id="editAddress" rows="2"
                          class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent"></textarea>
            </div>

            <div class="flex justify-end space-x-4">
                <button type="button" onclick="closeEditModal()" 
                        class="px-6 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 font-medium transition">
                    Cancel
                </button>
                <button type="submit" 
                        class="px-6 py-2 bg-primary hover:bg-primary-dark text-white rounded-lg font-medium transition">
                    <i class="fas fa-save mr-2"></i> Save Changes
                </button>
            </div>
        </form>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
let clientId = null;
let currentTab = 'debts';

function getClientId() {
    const path = window.location.pathname;
    const match = path.match(/\/clients\/(\d+)\//);
    return match ? match[1] : null;
}

async function loadClientData() {
    clientId = getClientId();
    if (!clientId) {
        alert('Invalid client ID');
        window.location.href = '/clients/';
        return;
    }

    try {
        // Load client basic info
        const clientResponse = await fetch(`/api/clients/${clientId}/`);
        const client = await clientResponse.json();
        
        document.getElementById('clientInitial').textContent = client.name.charAt(0).toUpperCase();
        document.getElementById('clientName').textContent = client.name;
        document.getElementById('clientEmail').textContent = client.email;
        document.getElementById('clientPhone').textContent = client.phone;
        
        if (client.address) {
            document.getElementById('clientAddress').textContent = client.address;
            document.getElementById('clientAddressContainer').style.display = 'block';
        }

        // Load balance info
        const balanceResponse = await fetch(`/api/clients/${clientId}/balance/`);
        const balance = await balanceResponse.json();
        
        document.getElementById('totalDebt').textContent = `${balance.total_debt.toFixed(0)} FRw`;
        document.getElementById('totalPaid').textContent = `${balance.total_paid.toFixed(0)} FRw`;
        document.getElementById('balance').textContent = `${balance.balance.toFixed(0)} FRw`;
        document.getElementById('activeDebts').textContent = balance.active_debts_count;

        // Load debts
        await loadDebts();
    } catch (error) {
        console.error('Error loading client data:', error);
        alert('Error loading client data');
    }
}

async function loadDebts() {
    try {
        const response = await fetch(`/api/debts/?client=${clientId}`);
        const data = await response.json();
        const debts = data.results || data;
        
        const tbody = document.getElementById('debtsTableBody');
        
        if (debts.length === 0) {
            tbody.innerHTML = '<tr><td colspan="7" class="px-6 py-4 text-center text-gray-500">No debts found</td></tr>';
            return;
        }
        
        tbody.innerHTML = debts.map(debt => {
            const statusColors = {
                'PENDING': 'bg-yellow-100 text-yellow-800',
                'PAID': 'bg-green-100 text-green-800',
                'OVERDUE': 'bg-red-100 text-red-800'
            };
            
            return `
                <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4 text-sm text-gray-900">${debt.description}</td>
                    <td class="px-6 py-4 text-sm text-gray-900">$${debt.amount}</td>
                    <td class="px-6 py-4 text-sm text-green-600">$${debt.amount_paid.toFixed(2)}</td>
                    <td class="px-6 py-4 text-sm font-semibold ${debt.remaining_balance > 0 ? 'text-red-600' : 'text-gray-900'}">
                        $${debt.remaining_balance.toFixed(2)}
                    </td>
                    <td class="px-6 py-4 text-sm text-gray-900">${debt.deadline}</td>
                    <td class="px-6 py-4">
                        <span class="px-2 py-1 text-xs font-semibold rounded-full ${statusColors[debt.status]}">
                            ${debt.status}
                        </span>
                    </td>
                    <td class="px-6 py-4 text-sm">
                        <a href="/debts/${debt.id}/" class="text-primary hover:underline">View</a>
                    </td>
                </tr>
            `;
        }).join('');
    } catch (error) {
        console.error('Error loading debts:', error);
    }
}

async function loadPayments() {
    try {
        const response = await fetch(`/api/payments/?client=${clientId}`);
        const data = await response.json();
        const payments = data.results || data;
        
        const tbody = document.getElementById('paymentsTableBody');
        
        if (payments.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" class="px-6 py-4 text-center text-gray-500">No payments found</td></tr>';
            return;
        }
        
        tbody.innerHTML = payments.map(payment => `
            <tr class="hover:bg-gray-50">
                <td class="px-6 py-4 text-sm text-gray-900">${payment.date}</td>
                <td class="px-6 py-4 text-sm text-gray-900">${payment.debt_amount} FRw</td>
                <td class="px-6 py-4 text-sm font-semibold text-green-600">${payment.amount} FRw</td>
                <td class="px-6 py-4 text-sm text-gray-900">${payment.reference_number || '-'}</td>
                <td class="px-6 py-4 text-sm text-gray-500">${payment.notes || '-'}</td>
            </tr>
        `).join('');
    } catch (error) {
        console.error('Error loading payments:', error);
    }
}

async function loadNotifications() {
    try {
        const response = await fetch(`/api/notifications/?client=${clientId}`);
        const data = await response.json();
        const notifications = data.results || data;
        
        const container = document.getElementById('notificationsList');
        
        if (notifications.length === 0) {
            container.innerHTML = '<p class="text-center text-gray-500">No notifications found</p>';
            return;
        }
        
        container.innerHTML = notifications.map(notif => {
            const statusColors = {
                'PENDING': 'bg-yellow-100 text-yellow-800',
                'SENT': 'bg-green-100 text-green-800',
                'FAILED': 'bg-red-100 text-red-800'
            };
            
            return `
                <div class="border border-gray-200 rounded-lg p-4">
                    <div class="flex justify-between items-start">
                        <div>
                            <h4 class="font-semibold text-gray-900">${notif.subject}</h4>
                            <p class="text-sm text-gray-600 mt-1">${notif.message.substring(0, 100)}...</p>
                            <p class="text-xs text-gray-500 mt-2">Scheduled: ${notif.scheduled_for}</p>
                        </div>
                        <span class="px-2 py-1 text-xs font-semibold rounded-full ${statusColors[notif.status]}">
                            ${notif.status}
                        </span>
                    </div>
                </div>
            `;
        }).join('');
    } catch (error) {
        console.error('Error loading notifications:', error);
    }
}

function switchTab(tab) {
    // Update tab buttons
    document.querySelectorAll('nav button').forEach(btn => {
        btn.className = 'px-6 py-4 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700';
    });
    document.getElementById(`${tab}Tab`).className = 'px-6 py-4 text-sm font-medium border-b-2 border-primary text-primary';
    
    // Update content
    document.getElementById('debtsContent').style.display = 'none';
    document.getElementById('paymentsContent').style.display = 'none';
    document.getElementById('notificationsContent').style.display = 'none';
    document.getElementById(`${tab}Content`).style.display = 'block';
    
    // Load data if not loaded
    if (tab === 'payments' && currentTab !== 'payments') {
        loadPayments();
    } else if (tab === 'notifications' && currentTab !== 'notifications') {
        loadNotifications();
    }
    
    currentTab = tab;
}

function editClient() {
    if (!clientData) return;
    
    document.getElementById('editName').value = clientData.name;
    document.getElementById('editEmail').value = clientData.email;
    document.getElementById('editPhone').value = clientData.phone || '';
    document.getElementById('editAddress').value = clientData.address || '';
    
    document.getElementById('editClientModal').classList.remove('hidden');
}

function closeEditModal() {
    document.getElementById('editClientModal').classList.add('hidden');
}

async function saveClientEdit(event) {
    event.preventDefault();
    
    const data = {
        name: document.getElementById('editName').value,
        email: document.getElementById('editEmail').value,
        phone: document.getElementById('editPhone').value,
        address: document.getElementById('editAddress').value
    };
    
    try {
        const response = await fetch(`/api/clients/${clientId}/`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify(data)
        });
        
        if (response.ok) {
            closeEditModal();
            loadClientDetails();
            alert('Client updated successfully!');
        } else {
            const error = await response.json();
            alert('Error: ' + JSON.stringify(error));
        }
    } catch (error) {
        console.error('Error updating client:', error);
        alert('Error updating client');
    }
}

async function deleteClient() {
    if (!confirm('Are you sure you want to delete this client? This will also delete all their debts and payments.')) {
        return;
    }
    
    try {
        const response = await fetch(`/api/clients/${clientId}/`, {
            method: 'DELETE',
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            }
        });
        
        if (response.ok) {
            alert('Client deleted successfully!');
            window.location.href = '/clients/';
        } else {
            alert('Error deleting client');
        }
    } catch (error) {
        console.error('Error deleting client:', error);
        alert('Error deleting client');
    }
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

document.addEventListener('DOMContentLoaded', loadClientData);
</script>
{% endblock %}
