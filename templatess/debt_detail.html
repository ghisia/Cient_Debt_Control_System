{% extends 'base.html' %}

{% block title %}Debt Details - DebtControl{% endblock %}

{% block extra_head %}
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<style>
    .select2-container--default .select2-selection--single {
        height: 42px;
        border: 1px solid #d1d5db;
        border-radius: 0.5rem;
        padding: 0.5rem 1rem;
    }
    .select2-container--default .select2-selection--single .select2-selection__rendered {
        line-height: 26px;
    }
    .select2-container--default .select2-selection--single .select2-selection__arrow {
        height: 40px;
    }
</style>
{% endblock %}

{% block content %}
<div class="px-4 py-6 sm:px-0">
    <!-- Back Button -->
    <div class="mb-4">
        <a href="/debts/" class="text-primary hover:text-primary-dark font-medium">
            <i class="fas fa-arrow-left mr-2"></i> Back to Debts
        </a>
    </div>

    <!-- Debt Header -->
    <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
        <div class="flex justify-between items-start mb-4">
            <div>
                <h1 class="text-3xl font-bold text-gray-900 mb-2" id="debtDescription">Loading...</h1>
                <p class="text-gray-600">
                    <i class="fas fa-calendar mr-2"></i> Created: <span id="createdDate"></span>
                </p>
            </div>
            <div class="flex space-x-2">
                <button onclick="editDebt()" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition">
                    <i class="fas fa-edit mr-2"></i> Edit
                </button>
                <button onclick="deleteDebt()" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg transition">
                    <i class="fas fa-trash mr-2"></i> Delete
                </button>
            </div>
        </div>

        <div id="statusBadge" class="inline-block"></div>
    </div>

    <!-- Financial Overview -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
        <div class="bg-blue-50 rounded-lg p-6 border-l-4 border-blue-500">
            <p class="text-sm text-gray-600 mb-2">Total Amount</p>
            <p class="text-2xl font-bold text-blue-600" id="totalAmount">0 FRw</p>
        </div>
        <div class="bg-green-50 rounded-lg p-6 border-l-4 border-green-500">
            <p class="text-sm text-gray-600 mb-2">Amount Paid</p>
            <p class="text-2xl font-bold text-green-600" id="amountPaid">0 FRw</p>
        </div>
        <div class="bg-red-50 rounded-lg p-6 border-l-4 border-red-500">
            <p class="text-sm text-gray-600 mb-2">Remaining Balance</p>
            <p class="text-2xl font-bold text-red-600" id="remainingBalance">0 FRw</p>
        </div>
        <div class="bg-purple-50 rounded-lg p-6 border-l-4 border-purple-500">
            <p class="text-sm text-gray-600 mb-2">Deadline</p>
            <p class="text-2xl font-bold text-purple-600" id="deadline"></p>
            <p class="text-xs text-gray-600 mt-1" id="daysRemaining"></p>
        </div>
    </div>

    <!-- Client Information -->
    <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
        <h2 class="text-xl font-bold text-gray-900 mb-4">
            <i class="fas fa-user mr-2"></i> Client Information
        </h2>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div>
                <p class="text-sm text-gray-600">Name</p>
                <p class="font-semibold text-gray-900" id="clientName">-</p>
            </div>
            <div>
                <p class="text-sm text-gray-600">Email</p>
                <p class="font-semibold text-gray-900" id="clientEmail">-</p>
            </div>
            <div>
                <p class="text-sm text-gray-600">Phone</p>
                <p class="font-semibold text-gray-900" id="clientPhone">-</p>
            </div>
        </div>
        <div class="mt-4">
            <a href="#" id="viewClientLink" class="text-primary hover:text-primary-dark font-medium">
                <i class="fas fa-arrow-right mr-2"></i> View Full Client Profile
            </a>
        </div>
    </div>

    <!-- Tabs -->
    <div class="bg-white rounded-lg shadow-lg overflow-hidden">
        <div class="border-b border-gray-200">
            <nav class="flex -mb-px">
                <button onclick="switchTab('payments')" id="paymentsTab" 
                        class="tab-button active px-6 py-4 text-sm font-medium border-b-2 border-primary text-primary">
                    <i class="fas fa-money-bill-wave mr-2"></i> Payments History
                </button>
                <button onclick="switchTab('notifications')" id="notificationsTab" 
                        class="tab-button px-6 py-4 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300">
                    <i class="fas fa-bell mr-2"></i> Notifications
                </button>
            </nav>
        </div>

        <!-- Payments Tab -->
        <div id="paymentsContent" class="tab-content p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold text-gray-900">Payment History</h3>
                <button onclick="showAddPaymentModal()" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg transition">
                    <i class="fas fa-plus mr-2"></i> Record Payment
                </button>
            </div>
            
            <div id="paymentsTable">
                <p class="text-gray-500 text-center py-4">
                    <i class="fas fa-spinner fa-spin mr-2"></i> Loading payments...
                </p>
            </div>
        </div>

        <!-- Notifications Tab -->
        <div id="notificationsContent" class="tab-content p-6 hidden">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold text-gray-900">Notification History</h3>
                <button onclick="sendReminder()" class="bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-2 rounded-lg transition">
                    <i class="fas fa-envelope mr-2"></i> Send Reminder
                </button>
            </div>
            
            <div id="notificationsTable">
                <p class="text-gray-500 text-center py-4">
                    <i class="fas fa-spinner fa-spin mr-2"></i> Loading notifications...
                </p>
            </div>
        </div>
    </div>
</div>

<!-- Add Payment Modal -->
<div id="paymentModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
    <div class="relative top-20 mx-auto p-5 border w-full max-w-md shadow-lg rounded-lg bg-white">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-2xl font-bold text-gray-900">Record Payment</h3>
            <button onclick="closePaymentModal()" class="text-gray-400 hover:text-gray-600">
                <i class="fas fa-times text-2xl"></i>
            </button>
        </div>
        
        <form id="paymentForm" onsubmit="savePayment(event)">
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">Amount *</label>
                <input type="number" id="paymentAmount" required step="0.01" min="0.01"
                       class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent"
                       placeholder="0.00">
                <p class="text-sm text-gray-500 mt-1">Remaining: $<span id="modalRemainingAmount">0.00</span></p>
            </div>

            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">Payment Date *</label>
                <input type="date" id="paymentDate" required
                       class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
            </div>

            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">Payment Method</label>
                <select id="paymentMethod" 
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
                    <option value="CASH">Cash</option>
                    <option value="BANK_TRANSFER">Bank Transfer</option>
                    <option value="CHECK">Check</option>
                    <option value="MOBILE_MONEY">Mobile Money</option>
                    <option value="OTHER">Other</option>
                </select>
            </div>

            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">Notes</label>
                <textarea id="paymentNotes" rows="2"
                          class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent"
                          placeholder="Optional notes..."></textarea>
            </div>

            <div class="flex justify-end space-x-4">
                <button type="button" onclick="closePaymentModal()" 
                        class="px-6 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 font-medium transition">
                    Cancel
                </button>
                <button type="submit" 
                        class="px-6 py-2 bg-green-500 hover:bg-green-600 text-white rounded-lg font-medium transition">
                    <i class="fas fa-save mr-2"></i> Save Payment
                </button>
            </div>
        </form>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script>
let debtData = null;
const debtId = window.location.pathname.split('/')[2];

async function loadDebtDetails() {
    try {
        const response = await fetch(`/api/debts/${debtId}/`);
        debtData = await response.json();
        displayDebtDetails(debtData);
        loadPayments();
        loadNotifications();
    } catch (error) {
        console.error('Error loading debt details:', error);
        alert('Error loading debt details');
    }
}

function displayDebtDetails(debt) {
    document.getElementById('debtDescription').textContent = debt.description;
    document.getElementById('createdDate').textContent = new Date(debt.created_at).toLocaleDateString();
    
    const statusColors = {
        'PENDING': 'bg-yellow-100 text-yellow-800',
        'OVERDUE': 'bg-red-100 text-red-800',
        'PAID': 'bg-green-100 text-green-800'
    };
    document.getElementById('statusBadge').innerHTML = 
        `<span class="px-3 py-1 text-sm font-semibold rounded-full ${statusColors[debt.status]}">${debt.status}</span>`;
    
    document.getElementById('totalAmount').textContent = `${parseFloat(debt.amount).toFixed(0)} FRw`;
    document.getElementById('amountPaid').textContent = `${parseFloat(debt.paid || 0).toFixed(0)} FRw`;
    
    const remaining = parseFloat(debt.amount) - parseFloat(debt.paid || 0);
    document.getElementById('remainingBalance').textContent = `${remaining.toFixed(0)} FRw`;
    document.getElementById('modalRemainingAmount').textContent = remaining.toFixed(0);
    
    const deadlineDate = new Date(debt.deadline);
    document.getElementById('deadline').textContent = deadlineDate.toLocaleDateString();
    
    const today = new Date();
    const daysUntil = Math.ceil((deadlineDate - today) / (1000 * 60 * 60 * 24));
    let daysText = '';
    if (daysUntil < 0) {
        daysText = `<span class="text-red-600">${Math.abs(daysUntil)} days overdue</span>`;
    } else if (daysUntil === 0) {
        daysText = '<span class="text-yellow-600">Due today!</span>';
    } else {
        daysText = `${daysUntil} days remaining`;
    }
    document.getElementById('daysRemaining').innerHTML = daysText;
    
    document.getElementById('clientName').textContent = debt.client_name || '-';
    document.getElementById('clientEmail').textContent = debt.client_email || '-';
    document.getElementById('clientPhone').textContent = debt.client_phone || '-';
    document.getElementById('viewClientLink').href = `/clients/${debt.client}/`;
    
    // Set today as default payment date
    document.getElementById('paymentDate').valueAsDate = new Date();
}

async function loadPayments() {
    try {
        const response = await fetch(`/api/payments/?debt=${debtId}`);
        const payments = await response.json();
        
        const container = document.getElementById('paymentsTable');
        
        if (payments.length === 0) {
            container.innerHTML = '<p class="text-gray-500 text-center py-4">No payments recorded yet</p>';
            return;
        }
        
        container.innerHTML = `
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Date</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Amount</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Method</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Notes</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        ${payments.map(payment => `
                            <tr>
                                <td class="px-4 py-3 text-sm text-gray-900">${new Date(payment.date).toLocaleDateString()}</td>
                                <td class="px-4 py-3 text-sm font-semibold text-green-600">${parseFloat(payment.amount).toFixed(0)} FRw</td>
                                <td class="px-4 py-3 text-sm text-gray-900">${payment.method || '-'}</td>
                                <td class="px-4 py-3 text-sm text-gray-500">${payment.notes || '-'}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        `;
    } catch (error) {
        console.error('Error loading payments:', error);
    }
}

async function loadNotifications() {
    try {
        const response = await fetch(`/api/notifications/?debt=${debtId}`);
        const notifications = await response.json();
        
        const container = document.getElementById('notificationsTable');
        
        if (notifications.length === 0) {
            container.innerHTML = '<p class="text-gray-500 text-center py-4">No notifications sent yet</p>';
            return;
        }
        
        container.innerHTML = `
            <div class="space-y-4">
                ${notifications.map(notif => `
                    <div class="border border-gray-200 rounded-lg p-4">
                        <div class="flex justify-between items-start mb-2">
                            <span class="text-sm font-semibold text-gray-900">${notif.subject}</span>
                            <span class="text-xs text-gray-500">${new Date(notif.sent_at).toLocaleString()}</span>
                        </div>
                        <p class="text-sm text-gray-600">${notif.message}</p>
                        <div class="mt-2">
                            <span class="text-xs px-2 py-1 rounded-full ${notif.sent ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'}">
                                ${notif.sent ? 'Sent' : 'Pending'}
                            </span>
                        </div>
                    </div>
                `).join('')}
            </div>
        `;
    } catch (error) {
        console.error('Error loading notifications:', error);
    }
}

function switchTab(tab) {
    document.querySelectorAll('.tab-button').forEach(btn => {
        btn.classList.remove('active', 'border-primary', 'text-primary');
        btn.classList.add('border-transparent', 'text-gray-500');
    });
    document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.add('hidden');
    });
    
    document.getElementById(`${tab}Tab`).classList.add('active', 'border-primary', 'text-primary');
    document.getElementById(`${tab}Content`).classList.remove('hidden');
}

function showAddPaymentModal() {
    document.getElementById('paymentForm').reset();
    document.getElementById('paymentDate').valueAsDate = new Date();
    document.getElementById('paymentModal').classList.remove('hidden');
}

function closePaymentModal() {
    document.getElementById('paymentModal').classList.add('hidden');
}

async function savePayment(event) {
    event.preventDefault();
    
    const data = {
        debt: parseInt(debtId),
        amount: parseFloat(document.getElementById('paymentAmount').value),
        date: document.getElementById('paymentDate').value,
        method: document.getElementById('paymentMethod').value,
        notes: document.getElementById('paymentNotes').value
    };
    
    try {
        const response = await fetch('/api/payments/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify(data)
        });
        
        if (response.ok) {
            closePaymentModal();
            loadDebtDetails();
            alert('Payment recorded successfully!');
        } else {
            const error = await response.json();
            alert('Error: ' + JSON.stringify(error));
        }
    } catch (error) {
        console.error('Error saving payment:', error);
        alert('Error saving payment');
    }
}

async function sendReminder() {
    try {
        const response = await fetch(`/api/notifications/send/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                debt: parseInt(debtId),
                subject: 'Payment Reminder',
                message: `This is a reminder about your pending debt. Amount: ${parseFloat(debtData.amount).toFixed(0)} FRw, Deadline: ${debtData.deadline}`
            })
        });
        
        if (response.ok) {
            loadNotifications();
            alert('Reminder sent successfully!');
        }
    } catch (error) {
        console.error('Error sending reminder:', error);
    }
}

function editDebt() {
    window.location.href = `/debts/?edit=${debtId}`;
}

async function deleteDebt() {
    if (!confirm('Are you sure you want to delete this debt? This action cannot be undone.')) return;
    
    try {
        const response = await fetch(`/api/debts/${debtId}/`, {
            method: 'DELETE',
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            }
        });
        
        if (response.ok) {
            alert('Debt deleted successfully!');
            window.location.href = '/debts/';
        }
    } catch (error) {
        console.error('Error deleting debt:', error);
    }
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

document.addEventListener('DOMContentLoaded', loadDebtDetails);
</script>
{% endblock %}
